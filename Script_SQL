-- Crear base de datos
CREATE DATABASE instituto
    CHARACTER SET utf8mb4
    COLLATE utf8mb4_general_ci;

USE instituto;

-- ========================
-- TABLA: Alumnos
-- ========================
CREATE TABLE Alumnos (
    ID_Alumno INT AUTO_INCREMENT PRIMARY KEY,
    Nombre_Completo VARCHAR(100) NOT NULL,
    DNI VARCHAR(20) NOT NULL UNIQUE,
    Email VARCHAR(100) NOT NULL UNIQUE
) ENGINE=InnoDB;

-- ========================
-- TABLA: Profesores
-- ========================
CREATE TABLE Profesores (
    ID_Profesor INT AUTO_INCREMENT PRIMARY KEY,
    Nombre_Completo VARCHAR(100) NOT NULL,
    DNI VARCHAR(20) NOT NULL UNIQUE,
    Email VARCHAR(100) NOT NULL UNIQUE
) ENGINE=InnoDB;

-- ========================
-- TABLA: Categorías
-- ========================
CREATE TABLE Categorias (
    ID_Categoria INT AUTO_INCREMENT PRIMARY KEY,
    Categoria VARCHAR(100) NOT NULL UNIQUE
) ENGINE=InnoDB;

-- ========================
-- TABLA: Carreras
-- ========================
CREATE TABLE Carreras (
    ID_Carrera INT AUTO_INCREMENT PRIMARY KEY,
    Nombre_Carrera VARCHAR(100) NOT NULL,
    ID_Categoria INT NOT NULL,
    CONSTRAINT fk_carrera_categoria FOREIGN KEY (ID_Categoria)
        REFERENCES Categorias(ID_Categoria)
        ON DELETE RESTRICT
        ON UPDATE CASCADE
) ENGINE=InnoDB;

-- ========================
-- TABLA: Turnos
-- ========================
CREATE TABLE Turnos (
    ID_Turno INT AUTO_INCREMENT PRIMARY KEY,
    Turno VARCHAR(50) NOT NULL,
    ID_Profesor INT NOT NULL,
    ID_Carrera INT NOT NULL,
    CONSTRAINT fk_turno_profesor FOREIGN KEY (ID_Profesor)
        REFERENCES Profesores(ID_Profesor)
        ON DELETE RESTRICT
        ON UPDATE CASCADE,
    CONSTRAINT fk_turno_carrera FOREIGN KEY (ID_Carrera)
        REFERENCES Carreras(ID_Carrera)
        ON DELETE RESTRICT
        ON UPDATE CASCADE
) ENGINE=InnoDB;


-- ========================
-- TABLA: Inscripciones
-- ========================
CREATE TABLE Inscripciones (
    ID_Alumno INT NOT NULL,
    ID_Carrera INT NOT NULL,
    ID_Turno INT NOT NULL,
    Fecha_Inscripcion TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY (ID_Alumno, ID_Turno),
    CONSTRAINT fk_inscripcion_alumno FOREIGN KEY (ID_Alumno)
        REFERENCES Alumnos(ID_Alumno)
        ON DELETE RESTRICT
        ON UPDATE CASCADE,
    CONSTRAINT fk_inscripcion_carrera FOREIGN KEY (ID_Carrera)
        REFERENCES Carreras(ID_Carrera)
        ON DELETE RESTRICT
        ON UPDATE CASCADE,
    CONSTRAINT fk_inscripcion_turno FOREIGN KEY (ID_Turno)
        REFERENCES Turnos(ID_Turno)
        ON DELETE RESTRICT
        ON UPDATE CASCADE
) ENGINE=InnoDB;


/** script SQL completo para agregar una columna user_id a tu tabla alumnos 
y establecer la relación con la tabla auth_identities como clave foránea**/
-- Usar la base de datos
USE instituto;

-- 1. Agregar la columna user_id a la tabla alumnos
ALTER TABLE alumnos
ADD COLUMN user_id INT(11) UNSIGNED NULL;
-- 2. Crear la relación con auth_identities
ALTER TABLE alumnos
ADD CONSTRAINT fk_alumnos_user
FOREIGN KEY (user_id)
REFERENCES auth_identities(id)
ON DELETE SET NULL
ON UPDATE CASCADE;


-- ========================
-- TABLA: auth_identities_reset
-- ========================
-- Tabla para almacenar tokens de recuperación de contraseña
-- Los tokens expiran después de 1 hora
CREATE TABLE auth_identities_reset (
    id INT(11) UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    email VARCHAR(255) NOT NULL,
    token VARCHAR(255) NOT NULL,
    created_at DATETIME NULL,
    INDEX idx_email (email),
    INDEX idx_token (token)
) ENGINE=InnoDB;

-- ========================
-- MODIFICAR TABLA: profesores
-- ========================
-- Agregar columna user_id y establecer relación con auth_identities
-- Usar la base de datos
USE instituto;

-- 1. Agregar la columna user_id a la tabla profesores
ALTER TABLE profesores
ADD COLUMN user_id INT(11) UNSIGNED NULL;

-- 2. Crear la relación con auth_identities
ALTER TABLE profesores
ADD CONSTRAINT fk_profesores_user
FOREIGN KEY (user_id)
REFERENCES auth_identities(id)
ON DELETE SET NULL
ON UPDATE CASCADE;
